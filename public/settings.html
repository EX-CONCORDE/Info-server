<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-dark text-light settings-body">
    <!-- Debug Monitor -->
    <div id="debug-monitor">
        <div class="debug-header">デバッグモニター</div>
        <div class="debug-content"></div>
    </div>

    <div class="container settings-page">
        <h1 class="mb-4">設定</h1>
        <form id="settings-form" class="col-md-8 col-lg-6 mx-auto">
            
            <div class="form-group mb-3">
                <label class="form-label">テンプレートRSS:</label>
                <div id="preset-rss-list" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                    <!-- テンプレートRSSのトグルがここに動的に生成されます -->
                </div>
            </div>

            <div class="form-group mb-3">
                <label for="rss-urls" class="form-label">カスタムRSSフィードURL (1行に1つ):</label>
                <textarea id="rss-urls" class="form-control" rows="4" placeholder="上記テンプレートにないRSSフィードを追加"></textarea>
            </div>
            <div class="form-group mb-3">
                <label for="scroll-speed" class="form-label">ニュース速度 (ピクセル/秒):</label>
                <input type="number" id="scroll-speed" class="form-control" placeholder="例: 120" required>
            </div>
             <div class="form-group mb-3">
                <label class="form-label">位置情報:</label>
                <div class="input-group">
                    <input type="number" step="any" id="latitude" class="form-control" placeholder="緯度" required>
                    <input type="number" step="any" id="longitude" class="form-control" placeholder="経度" required>
                    <button class="btn btn-outline-secondary" type="button" id="get-location-btn" title="現在地を取得">
                        <i class="bi bi-geo-alt-fill"></i>
                    </button>
                </div>
                <div id="location-status" class="form-text"></div>
            </div>
            <hr>
            <div class="form-group mb-3">
                <label class="form-label">表示する天気情報:</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-wind">
                    <label class="form-check-label" for="show-wind">風速・風向</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-pressure">
                    <label class="form-check-label" for="show-pressure">湿度・気圧</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="show-visibility">
                    <label class="form-check-label" for="show-visibility">雲量・視程</label>
                </div>
            </div>
            <hr>
            <div class="form-group mb-3">
                <label class="form-label">デバイス最適化:</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="ipad-mode">
                    <label class="form-check-label" for="ipad-mode">iPad (9th Gen) レイアウト</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="debug-overlay">
                    <label class="form-check-label" for="debug-overlay">メイン画面にデバッグ情報をオーバーレイ</label>
                </div>
            </div>
            <button type="submit" class="btn btn-primary w-100">保存</button>
        </form>
        <a href="/" class="back-link mt-4">ダッシュボードに戻る</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // --- デバッグモニター設定 ---
            const debugOverlayEnabled = JSON.parse(localStorage.getItem('debugOverlay') || 'false');
            if (!debugOverlayEnabled) {
                const debugContent = document.querySelector('#debug-monitor .debug-content');
                function logToMonitor(message, type = 'log') {
                    const entry = document.createElement('div');
                    entry.className = `debug-entry text-${type === 'error' ? 'danger' : 'light'}`;
                    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                    debugContent.appendChild(entry);
                    debugContent.scrollTop = debugContent.scrollHeight;
                }
                const originalConsole = { log: console.log, error: console.error, warn: console.warn };
                console.log = (...args) => { logToMonitor(args.join(' ')); originalConsole.log(...args); };
                console.error = (...args) => { logToMonitor(args.join(' '), 'error'); originalConsole.error(...args); };
                console.warn = (...args) => { logToMonitor(args.join(' '), 'warn'); originalConsole.warn(...args); };
                console.log("設定画面デバッグモニターが初期化されました。");
            } else {
                $('#debug-monitor').hide();
                $('body').removeClass('settings-body');
            }

            // --- テンプレートRSSデータ ---
            const presetFeeds = {
                '読売新聞':'https://www.yomiuri.co.jp/rss/yol/topstories.xml',
                '朝日新聞':'https://www.asahi.com/rss/asahi/newsheadlines.rdf',
                '毎日新聞':'https://mainichi.jp/rss/etc/mainichi-flash.rss',
                '産経新聞':'https://www.sankei.com/main/rss/main-flash.xml',
                '日経新聞':'https://www.nikkei.com/rss/2.0/news_BreakingNews.xml',
                'NHK':'https://www.nhk.or.jp/rss/news/cat0.xml',
                '共同通信':'https://www.kyodo.co.jp/c/rss/flash.xml',
                '時事通信':'https://www.jiji.com/rss/ranking.xml',
                'Yahoo!ニュース':'https://news.yahoo.co.jp/rss/topics/top-picks.xml',
                'Googleニュース':'https://news.google.com/rss?hl=ja&gl=JP&ceid=JP:ja',
                'ITmedia NEWS':'https://rss.itmedia.co.jp/rss/2.0/news_bursts.xml',
                'CNET Japan':'https://japan.cnet.com/rss/index.rdf',
                'TechCrunch':'https://techcrunch.com/feed/',
                'GIZMODO':'https://www.gizmodo.jp/index.xml',
                'WIRED':'https://www.wired.jp/feed/',
                'Engadget':'https://japanese.engadget.com/rss.xml',
                'GIGAZINE':'https://gigazine.net/news/rss_2.0/',
                'はてなブックマーク':'https://b.hatena.ne.jp/hotentry/all.rss'
            };

            const presetList = $('#preset-rss-list');
            Object.entries(presetFeeds).forEach(([name, url]) => {
                const switchId = `preset-${name.replace(/[^a-zA-Z0-9]/g, '')}`;
                presetList.append(`
                    <div class="form-check form-switch">
                        <input class="form-check-input preset-rss-toggle" type="checkbox" id="${switchId}" data-url="${url}">
                        <label class="form-check-label" for="${switchId}">${name}</label>
                    </div>`);
            });

            // --- 位置情報取得ボタンの処理 ---
            $('#get-location-btn').on('click', function() {
                const $status = $('#location-status');
                if (!navigator.geolocation) {
                    $status.text('お使いのブラウザは位置情報取得に対応していません。').addClass('text-danger');
                    return;
                }

                $status.text('位置情報を取得中...').removeClass('text-danger text-success');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        $('#latitude').val(latitude.toFixed(6));
                        $('#longitude').val(longitude.toFixed(6));
                        $status.text('位置情報を取得しました。').addClass('text-success');
                    },
                    (error) => {
                        let message = '位置情報の取得に失敗しました。';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message += ' (許可されませんでした)';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message += ' (位置を特定できませんでした)';
                                break;
                            case error.TIMEOUT:
                                message += ' (タイムアウトしました)';
                                break;
                        }
                        $status.text(message).addClass('text-danger');
                    }
                );
            });

            // --- 設定の読み込み ---
            function loadSettings() {
                console.log("設定をlocalStorageから読み込んでいます...");
                const savedUrls = (localStorage.getItem('rssUrls') || '').split('\n').filter(Boolean);
                $('.preset-rss-toggle').each(function() {
                    $(this).prop('checked', savedUrls.includes($(this).data('url')));
                });
                const customUrls = savedUrls.filter(url => !Object.values(presetFeeds).includes(url));
                $('#rss-urls').val(customUrls.join('\n'));
                $('#scroll-speed').val(localStorage.getItem('scrollSpeed') || '120');
                $('#latitude').val(localStorage.getItem('latitude'));
                $('#longitude').val(localStorage.getItem('longitude'));
                $('#show-wind').prop('checked', JSON.parse(localStorage.getItem('showWind') || 'true'));
                $('#show-pressure').prop('checked', JSON.parse(localStorage.getItem('showPressure') || 'true'));
                $('#show-visibility').prop('checked', JSON.parse(localStorage.getItem('showVisibility') || 'true'));
                $('#ipad-mode').prop('checked', JSON.parse(localStorage.getItem('ipadMode') || 'false'));
                $('#debug-overlay').prop('checked', debugOverlayEnabled);
                console.log("設定の読み込みが完了しました。");
            }
            loadSettings();

            // --- 設定の保存 ---
            $('#settings-form').on('submit', function(e) {
                e.preventDefault();
                console.log("設定を保存しています...");
                const selectedPresetUrls = $('.preset-rss-toggle:checked').map(function() { return $(this).data('url'); }).get();
                const customUrls = ($('#rss-urls').val() || '').split('\n').filter(Boolean);
                const allUrls = [...new Set([...selectedPresetUrls, ...customUrls])];
                
                localStorage.setItem('rssUrls', allUrls.join('\n'));
                localStorage.setItem('scrollSpeed', $('#scroll-speed').val());
                localStorage.setItem('latitude', $('#latitude').val());
                localStorage.setItem('longitude', $('#longitude').val());
                localStorage.setItem('showWind', $('#show-wind').prop('checked'));
                localStorage.setItem('showPressure', $('#show-pressure').prop('checked'));
                localStorage.setItem('showVisibility', $('#show-visibility').prop('checked'));
                localStorage.setItem('ipadMode', $('#ipad-mode').prop('checked'));
                localStorage.setItem('debugOverlay', $('#debug-overlay').prop('checked'));

                console.log("保存されたRSSフィード:", allUrls);
                alert('設定を保存しました。');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html>
